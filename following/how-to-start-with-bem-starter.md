# Быстрое создание БЭМ-проекта
Эта статья рассказывает о том, как создать проект с использованием
БЭМ-технологий.<br/>
Мы шаг за шагом создадим
[страничку каталога товаров](http://toivonen.github.com/online-shop-dummy/desktop.bundles/index/index.html
), пользуясь принципами БЭМ в CSS, возможностями писать декларативный JavaScript
на фреймворке `i-bem.js` и с использованием шаблонизатора `BEMHTML`. Помогать делать
всё это будут `bem tools`, в частности — инструмент для разработки `bem server`.

## Что такое БЭМ?
Для начала небольшое лирическое отступление для тех, кто не в курсе,
что обозначает эта аббревиатура.<br/>
БЭМ расшифровывается как «Блок, Элемент, Модификатор». Это методология
разработки web-проектов, способ удобно делить интерфейс на отдельные штучки,
применимый для любой технологии. Кроме того, БЭМ — это набор инструментов для
автоматизации работы. И наконец, БЭМ — это возможность создания интерфейсных
библиотек для быстрой и эффективной разработки.

Если ранее вы не сталкивались с БЭМ, вам стоит вначале просмотреть материалы
сайта [bem.info](http://bem.info/), а затем вернуться к этой статье.<br/>
Для тех, кому больше нравится видео, могу предложить
[запись доклада с WebConf Riga 2012](https://vimeo.com/53219242) (на
английском) или
[выступление Сергея Бережного (@veged) на РИТ 2011](http://my.comdi.com/event_export/_rec/rit/01/?room=2&rec=25).

## Необходимые инструменты
Чтобы пройти по всем шагам этого мануала, вам нужно установить
[bem tools](https://github.com/bem/bem-tools). Это набор инструментов с
command line интерфейсом для оперирования БЭМ-сущностями и сборки проекта.
Инструкция по установке есть в описании репозитория.

Будут использоваться команды:
 * `bem create`<br/>
 создаёт файлы блоков, элементов и модификаторов
 * `bem server`<br/>
 сервер, пересобирающий части проекта на лету (при наличии изменений)
 * `bem make`<br/>
 собирает весь проект (для выкатки в продакшен)

## Болванки для создания проекта
Создание БЭМ-проекта можно начинать с копирования специальных репозиториев, где
всё настроено для использования bem tools.

### Как устроен project-stub
Один из таких репозиториев -- [project-stub](https://github.com/bem/project-stub)<sup>[1](#ref1)</sup>.
Это минимальная конфигурация для использования БЭМ-сборки.

В проекте есть файл `packadge.json`, подтягивающий необходимые для проекта
npm-пакеты. В нашем случае это пакет `bem` для локального использования.

Директория `.bem` используется для хранения конфигураций уровня
переопределения.<br/>
По БЭМ уровни переопределения — это сам проект, директории с блоками и
дирректории с бандлами (страницами).

#### Конфигурация проекта
Для уровня проекта необходим конфигурирующий файл
[make.js](https://github.com/bem/project-stub/blob/master/.bem/make.js).
Он сообщает командам `bem make` и `bem sever` информацию о том, как собирать
проект.<br/>
В этом примере задаются директории блоков и бандлов, при помощи RegExp-based
синтаксиса, устанавливаются необходимые библиотеки и перечисляются технологии,
которые необходимо собирать на уровнях бандлов.

#### Используемые библиотеки
На данный момент проект использует 2 библиотеки:
 * [bemhtml](https://github.com/bem/bemhtml)<br/>
    В библиотеке есть один блок, подключение которого позволяет любому проекту использовать шаблонизатор BEMHTML.
 * [bem-bl](https://github.com/bem/bem-bl)<br/>
   Библиотека простых блоков.

В проекте есть 3 уровня переопределения: 2 для блоков и один для бандлов
(страниц).

#### Уровни переопределения
Уровни для блоков называются
[common.blocks](https://github.com/bem/project-stub/tree/master/common.blocks)
и [desktop.blocks](https://github.com/bem/project-stub/tree/master/desktop.blocks).<br/>
Настройки уровней находятся в файлах ##.bem/level.js##. Для этих уровней они
одинаковые, наследуются от одного и того же описания уровня
[.bem/levels/blocks.js](https://github.com/bem/project-stub/blob/master/.bem/levels/blocks.js) и ничего не переопределяют. Список технологий,
используемых блоками, в проекте ##project-stub## обнулён, на базе этого проекта может быть
построен любой с любыми технологиями.

На уровне ##common.blocks## находится лишь один блок, описывающий зависимости в
технологии
[deps.js](https://github.com/bem/project-stub/blob/master/common.blocks/i-bem/__dom/i-bem__dom.deps.js):

    ({
      mustDeps: { block: 'bemhtml' },
      noDeps: { block: 'i-bem', elems: 'html' }
    })

Такая зависимость позволяет подключить ко всем страницам шаблонизатор `BEMHTML`.
Он нужен для любой версии сайта, поэтому находится на уровне
`common.blocks`.<br/>
Директива `noDeps` исключает подключение шаблонизатора из библиотеки `bem-bl`.
Это временная мера на период, пока шаблонизатор переезжает в отдельную библиотеку,
но сохраняется обратная совместимость.

На уровне `desktop.blocks` определён блок
[b-page](https://github.com/bem/project-stub/tree/master/desktop.blocks/b-page).
Его зависимости обеспечивают подключение кода, который инициализирует
JavaScript всех блоков по domReady:

    ({
        mustDeps: [
            {
                block: 'i-bem',
                elem: 'dom',
                mods: { init: 'auto' }
            },
            { block: 'bemhtml' }
        ],
        noDeps: [
            {
                block: 'i-bem',
                elem: 'html'
            }
        ]
    })

Уровень переопределения `desktop.bundles` содержит входные данные для страниц
и настройки сборки.<br/>
Как и все настройки уровня, конфигурация сборки содержится в файле
[.bem/level.js](https://github.com/bem/project-stub/blob/master/desktop.bundles/.bem/level.js) уровня.
Там прописано наследование от общего файла
для бандлов [.bem/levels/bundles.js](https://github.com/bem/project-stub/blob/master/.bem/levels/bundles.js)
и собственные доопределения.<br/>
Там же вы можете видеть список уровней переопределения, блоки которых
будут использоваться для сборки страниц этого бандла.

#### Настройки сборки
В общем конфигурационном файле про бандлы
[.bem/levels/bundles.js](https://github.com/bem/project-stub/blob/master/.bem/levels/bundles.js) указано,
по каким шаблонам собирать различные технологии.

### Как устроен full-stack-starter
Репозиторий [full-stack-starter](https://github.com/bem/full-stack-starter)<sup>[2](#ref2)</sup>
имеет такую же архитектуру, но немного расширен для использования полного стека
БЭМ.

#### Настройки уровней с блоками
Для уровней с блоками здесь определено, по каким шаблонам должны создаваться
файлы технологий блоков. Это сделано в файле
[./bem/levels/level.js](https://github.com/bem/full-stack-starter/blob/master/.bem/levels/blocks.js).<br/>
Шаблон определяет, с каким содержимым создастся файл блока, элемента или
модификатора при использовании команды `bem create`.<br/>
Для большинства технологий используются дефолтные шаблоны из bem tools. Для
JavaScript файлов блоков — шаблон из библиотеки bem-bl, а для файлов с BEMHTML
— шаблон из библиотеки bemhtml.

Также определён дефолтный список технологий. Это те технологии, с которыми
по-умолчанию создаётся новый блок.

#### Настройки уровней с бандлами
Настройки уровней, хранящих собранные страницы изменены несильно. Изменения
внесены в файл
[./bem/levels/bundles.js](https://github.com/bem/full-stack-starter/blob/master/.bem/levels/bundles.js)
и заключаются в определении дефолтной технологии для
страниц.<br/>
Проект расчитан на описание всех страниц в `bemjson`.

Шаблон технологии bemjson, использующийся при создании новых страниц, также
размещён в проекте в файле
[./bem/techs/bemjson.js.js](https://github.com/bem/full-stack-starter/blob/master/.bem/techs/bemjson.js.js).

## Создание собственного репозитория проекта
Новый проект создаётся простым копированием репозитория:

    $ git clone git://github.com/bem/full-stack-starter.git my-pretty-project
    $ cd my-pretty-project/
    $ rm -rf .git
    $ git init

Затем проект нужно собрать. Для этого запускается команда

    make

Это занимает некоторое время, потому что именно в этот момент в директорию
проекта устанавливаются все необходимые npm-пакеты.<br/>
В конце вы увидите следующее сообщение:

    info: Server is listening on port 8080. Point your browser to http://localhost:8080/

На вашем компьютере запустился `bem server`<sup>[3](#ref3)</sup> — инструмент для разработки,
который будет автоматически пересобирать ваш проект, если вы внесете в него
изменения.

## Внесение изменения в страницы
Сейчас на вашем проекте есть одна страница
[index.html](http://localhost:8080/desktop.bundles/index/index.html), которую
вы можете открыть в браузере.<br/>
Первый запрос к странице будет обрабатываться заметное время, потому что в этот
момент bem server подгружает необходмые для её сборки библиотеки.

Вы можете отредактировать страницу, меняя файл
`desktop.bundles/index/index.bemjson.js`.

### Описание блока в bemjson
Сначала мы разместим на странице Шапку. В терминах БЭМ это блок `head`:

    {
      block: 'head'
    }
Здесь и далее полный код страницы на разных стадиях можно будет находить
на Gist: https://gist.github.com/4175550.

Перезагрузив страницу, вы увидите что в ней появился соответствующий `<div>`.

Шапку мы наполним содержанием: форма поиска, логотип и раскладка,
располагающая содержание как нужно.

Сначала в BEMJSON-описании страницы внутрь блока `head` помещаем блок
`layout` с двумя элементами: `left` и `right`.<br/>
https://gist.github.com/4175573

Это создаст необходимую разметку (вы можете увидеть её, обновив страницу), к
которой нужно написать стили. То есть реализовать блок `layout` в технологии
CSS.

## Создание блока
Для создания файла технологии воспользуемся командой `bem create`.

    $ bem create block -l desktop.blocks/ -T css layout

Команда создаст файл `desktop.blocks/layout/layout.css`, в котором уже есть
селектор, соответствующий файлу блока. Правило нужно дополнить соответственно
назначению блока.<br/>
Сейчас можно просто скопировать: https://gist.github.com/4175598

Подробно о возможностях команды `bem create` можно узнать, набрав `bem create
--help`.

## Использование блоков из библиотек
Вложенные в `layout` блоки поисковой формы и логотипа реализовывать
самостоятельно не нужно. Они уже реализованы в
[библиотеке bem-bl](http://bem.github.com/bem-bl/index.ru.html), достаточно
просто задекларировать их на странице.

У каждого из блоков библиотеки есть своя страница. Например,
[страница блока b-search](http://bem.github.com/bem-bl/sets/common-desktop/b-search/b-search.ru.html).
Она описывает блок, а внизу можно найти несколько iframe с примерами его использования.
По ссылке `исходный код` можно найти тот
BEMJSON, который нужно вставить на страницу для использования блока.

Для нашей страницы мы воспользуемся блоками
[b-search](http://bem.github.com/bem-bl/sets/common-desktop/b-search/b-search.ru.html) и
[b-logo](http://bem.github.com/bem-bl/sets/common-desktop/b-logo/b-logo.ru.html).<br/>
(https://gist.github.com/4175640)

Картинку для логотипа можно взять
[отсюда](http://toivonen.github.com/online-shop-dummy/desktop.blocks/b-logo/b-logo.png) или указать свою.

### Доопределение блоков библиотек
#### Доопределение в CSS
Любой блок библиотеки можно доопределить (дописать) на своём уровне в любой
технологии. Некоторые блоки специально написаны с учётом этой возможности.

Например, используемый нами блок `b-logo` предоставляет только нужную
разметку. CSS для неё каждый разработчик может написать сам, потому что всем
нужна разная разметка.

Доопределение блока ничем не отличается от создания блока на своём уровне.
Единственное требование -- совпадение имён с библиотечным блоком.

    $ bem create block -l desktop.blocks/ -T css b-logo
Разметку для блока можно взять отсюда: https://gist.github.com/4175675

То же самое для блока `b-search`:

    $ bem create block -l desktop.blocks/ -T css b-search
https://gist.github.com/4195433

#### Доопределение BEMHTML
При необходимости изменить разметку, мы должны переопределить технологию блока
BEMHTML (шаблоны, отвечающие за создание разметки).

Для данной страницы нужен дополнительный контейнер, чтобы сделать её
центрированной.

Создаём на своём уровне переопределения технологию BEMHTML для блока
`b-page`:

    $ bem create block -l desktop.blocks/ -T bemhtml b-page

В получившемся файле `desktop.blocks/b-page/b-page.bemhtml` нужно написать
код, оборачивающий контент блока в дополнительный контейнер.<br/>
https://gist.github.com/4175742 <sup>[4](#ref4)</sup>

Для получившейся разметки создаются свои CSS-правила:

    $ bem create block -l desktop.blocks/ -T css b-page

Контент для получившегося файла `desktop.blocks/b-page/b-page.css` можно
скопировать отсюда: https://gist.github.com/4175763

А для того, чтобы блок шапки был заметен на странице, я задам ему border:

    $ bem create block -l desktop.blocks/ -T css head

Контент для файла `desktop.blocks/head/head.css`: https://gist.github.com/4175776.

## BEMHTML шаблоны
В странице не обязательно полностью описывать всю структуру блока, так как у
шаблонов есть возможность принять эту логику на себя.

Проектируя свой собственный блок, вы можете сделать так, что его декларация
очень короткая и нужна только для передачи данных, а всю разметку делает шаблон.

Например, давайте разместим на странице список товаров. Он представлен в
BEMJSON-декларации страницы блоком `goods`, и декларация содержит необходимые
данные https://gist.github.com/4176078.

Для того, чтобы эти данные превратились в нужную разметку, блок должен быть
реализован в технологии BEMHTML. Для внешнего вида — технология CSS.<br/>
Если при создании блока не указывать флаг `-T`, он создастся во всех
технологиях, определённых как дефолтные для этого уровня:

    $ bem create block -l desktop.blocks goods

В BEMHTML шаблоне блока `desktop.blocks/goods/goods.bemhtml` нужно написать
код, который превратит JSON с данными в элементы блока. А также, пользуясь
модой `tag` указать, какими DOM-элементами представить блок и его элементы.<br/>
https://gist.github.com/4176118

Шаблон может создавать не только элементы блока, но и другие блоки. Например,
цену товара можно завернуть в ссылку, используя для этого блок `b-link` из
библиотеки `bem-bl`.<br/>
Код шаблона при этом изменится вот так https://gist.github.com/4176996.

Кроме того, для того, чтобы избежать каскада при оформлении этой ссылки стилями,
её можно пометить как элемент блока `goods`.<br/>
https://gist.github.com/4177113

Также нужно пометить элементы о новых товарах модификатором и добавить
выравнивающих элементов.<br/>
https://gist.github.com/4177157

CSS для блока можно скопировать отсюда https://gist.github.com/4177163.

Понадобится и CSS для IE.

    $ bem create block -l desktop.blocks/ -T ie.css goods

Содержание для получившегося файла `desktop.blocks/goods/goods.ie.css` можно
взять на Gist https://gist.github.com/4177174

## Зависимости блоков
Помимо декларации нужно гарантировать подключение к странице шаблонов, CSS и
JavaScript блока. Для этого у блока можно описать зависимости, это делается
представлением блока в технологии `deps.js`.

    $ bem create block -l desktop.blocks/ -T deps.js goods

Секция `mustDeps` описывает зависимости, которые обязательно нужно подключить
до текущего блока. В данном случае она не нужна, можно воспользоваться менее
строгой зависимостью `shouldDeps`, указав, что нужен блок `b-link`.<br/>
https://gist.github.com/4177031

## Подключение библиотек
Я хочу представить шапку и каждый товар модными прямоугольниками с тенью. Блок
для этого я позаимствую из [библотеки моего друга](https://github.com/john-johnson/j).<br/>
Там есть всего один блок, который называется ##box## и делает то, что мне нужно.

Чтобы получить код библиотеки, мне нужно указать её адрес в `./bem/make.js`,
по аналогии с соседними библиотеками.<br/>
https://gist.github.com/4177229

А также указать в настройках бандлов (страниц), что этот уровень нужно
использовать при сборке. Это делается в файле
`desktop.bundles/.bem/level.js`.<br/>
https://gist.github.com/4177250

К сожалению, пока что при изменении конфигурации проекта приходится
перезапускать `bem server`. Текущий процесс придётся прервать и снова набрать
команду `make`.<br/>
В будущих версиях необходимость перезапуска обещают убрать.

## Миксы блоков и элементов
Теперь можно использовать блок `box#` Я могу просто обернуть им мои блоки. Но
чтобы сэкономить разметку, можно воспользоваться миксами (`mix`).

Миксы позволяют разместить на одной DOM-ноде несколько блоков, или блок и
элемент, или несколько элементов.

Миксы можно задавать во входных данных (BEMJSON). Например,  можно смешать блок
`head` с блоком `box`, изменив код страницы.

    {
        block: 'head',
        mix: [ { block: 'box' } ],
        content: ...
    }
https://gist.github.com/4177292

Также можно применять миксы в BEMHTML шаблонах. Смешивать можно не только блоки,
но и элементы с блоками.<br/>
В шаблоне блока `goods` я смешаю каждый элемент `item` с блоком `box`.

    content.push({
        elem: 'item',
        mods: mods,
        mix: [{ block: 'box' }],
        content: ...
https://gist.github.com/4177350

## Создание новых страниц

Страницы — это тоже блоки, на своём уровне переопределения. Поэтому для
их создания тоже можно воспользоваться командой `bem create`:

    bem create block -l desktop.bundles contact
    
Флаг `-T` можно не указывать, потому что `bem create` благодаря настройкам
уровня `desktop.bundles` знает, что создаваемые на этом уровне блоки
должны быть представлены в технологии BEMJSON. Так, появляется файл
`desktop.bundles/contact/contact.bemjson.js` с минимальным содержимым для
страницы.

Новую страницу можно посмотреть по адресу http://localhost:8080/desktop.bundles/contact/contact.html<br/>
`bem server` соберёт её HTML, JS и CSS файлы в момент первого обращения.

## Инкапсулирование логики блока
На новой странице я тоже хочу разместить блок `head`. Можно скопировать его BEMJSON
со страницы `index`. Но такое копирование будет копипастом, который сложно
поддерживать.<br/>
Вместо этого есть возможность задекларировать лишь присутствие блока `head` на странице:

    {
        block: 'head'
    }
https://gist.github.com/4195604

Создание необходимой разметки в этом случае перекладывается на BEMHTML шаблон
блока.

    bem create block -l desktop.blocks -T bemhtml head

В получившемся файле `desktop.blocks/head/head.bemhtml` нужно описать
содержание блока в виде BEMJSON (то же самое, что было написано в `index.bemjson.js`):

    block head {

        content: {
            block: 'layout',
            ....
https://gist.github.com/4195646

Для корректного отображения вложенных блоков их нужно перечислить в зависимостях
`head.deps.js`, которые тоже создаются при помощи `bem create`:

    bem create block -l desktop.blocks -T deps.js head
https://gist.github.com/4195666

Информация о смешивании блока `head` с блоком `box` тоже должна быть
записана в шаблон, но уже на языке мод шаблонизатора:

    block head {

       mix: [{ block: 'box'}]

       content: {
https://gist.github.com/4195689

И, как всегда при упоминании нового блока в шаблоне, он должен быть
добавлен в зависимости https://gist.github.com/4195694

Теперь, когда декларация блока сократилась до его имени, BEMJSON
страницы `index` тоже можно изменить:

    ({
        block: 'b-page',
        title: 'index',
        head: [
            { elem: 'css', url: '_index.css', ie: false},
            { elem: 'css', url: '_index.ie.css', ie: true },
            { block: 'i-jquery', elem: 'core'},
            { elem: 'js', url:'_index.js'},
        ],
        content: [
            {
                block: 'head'
            },
            ...
        ]
    })
https://gist.github.com/4195706

## Декларативный JavaScript
### Блоки с JavaScript функциональностью
Блок `box`, который появился у меня на проекте благодаря подключенной
сторонней библиотеке, предоставляет также и динамическую JavaScript-функциональность:
он умеет сворачиваться.

Для сообщения, что я хочу использовать эту JavaScript-функциональность в
шапке, мне нужно изменить шаблон блока `head` и описать там примешиваемый
блок `box` как имеющий JavaScript-реализацию:

    mix: [{ block: 'box', js: true }]

Также требуется разместить внутри блока элемент `switcher`

    block head {

        mix: [{ block: 'box', js: true }]

        content: [
            {
                block: 'layout',
                ...
             },
            {
                block: 'box',
                elem: 'switcher'
            }
        ]
    }
https://gist.github.com/4195773

Получается блок со стрелочкой, которая умеет сворачивать и разворачивать его.

### Доопределение JavaScript
Мне недостаточно JavaScript-функциональности блока `box`. Я хочу, чтобы он
сворачивался не только по вертикали, но и по горизонтали. При этом вносить
изменения в чужую библиотеку я не могу. Но благодаря тому, что JavaScript блока
написан с использованием
[декларативного фреймворка из блока i-bem](http://bem.github.com/bem-bl/sets/common-desktop/i-bem/i-bem.ru.html),
у меня есть возможность изменить (переопределить или доопределить) поведение блока
на своём уровне.

    bem create block -l desktop.blocks -T js box
    
В получившемся файле `desktop.blocks/box/box.js` мы удалим секцию
статических методов, так как не собираемся их переопределять и оставим
только `onSetMod`, описывающий реакцию на установку модификаторов.

    onSetMod : {

    }
https://gist.github.com/4195865

В данном случае нужно реагировать на установку и снятие модификатора `closed`:

    onSetMod : {

        'closed': {
            'yes': function() {
                // some functionality here
            },
            '': function() {
                // some functionality here
            }
        }

    }
https://gist.github.com/4195879

---------------------
<sup><a name="ref1"></a>1</sup> Репозиторий описан в ревизии
[ebf605bc2a](https://github.com/bem/project-stub/commit/ebf605bc2ad031b73fef562df10d23a8b1edd63c)
<sup><a name="ref2"></a>2</sup> Репозиторий описан в ревизии
[4e24d717e6](https://github.com/bem/full-stack-starter/commit/4e24d717e614aa3d7d3c060a6301b68ff6ec6424)
<sup><a name="ref3"></a>3</sup> Подробнее о `bem server` можно узнать из докладов
Владимира Алаева [Новые возможности bem tools](http://events.yandex.ru/talks/289/) и
Сергея Белова [bem server: Система сборки фронтенда](http://events.yandex.ru/talks/154/).
<sup><a name="ref4"></a>4</sup> Информацию о синтаксисе шаблонизатора BEMHTML можно найти в референсе
((https://github.com/bem/bemhtml/blob/master/common.docs/reference/reference.ru.md))

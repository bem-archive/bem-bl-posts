# Быстрое создание БЭМ-проекта
Эта статья рассказывает о том, как создать проект с использованием
БЭМ-технологий.\\
Мы шаг за шагом создадим
((http://toivonen.github.com/online-shop-dummy/desktop.bundles/index/index.html
страничку каталога товаров)),
пользуясь принципами БЭМ в CSS, возможностями писать декларативный JavaScript
на фреймворке ##i-bem.js## и с использованием шаблонизатора ##BEMHTML##.

## Что такое БЭМ?
Для начала небольшое лирическое отступление для тех, кто не в курсе,
что обозначает эта аббревиатура.\\
БЭМ расшифровывается как "Блок, Элемент, Модификатор". Это методология
разработки web-проектов, способ удобно делить интерфейс на отдельные штучки,
применимый для любой технологии. Кроме того, БЭМ -- это набор инструментов для
автоматизации работы. И наконец, БЭМ -- это возможность создания интерфейсных
библиотек для быстрой и эффективной разработки.

Если ранее вы не сталкивались с БЭМ, вам стоит вначале просмотреть материалы
сайта ((http://bem.info/ bem.info)), а затем вернуться к этой статье.\\
Для тех, кому больше нравится видео, могу предложить
((https://vimeo.com/53219242 запись доклада с WebConf Riga 2012)) (на
английском) или ((http://my.comdi.com/event_export/_rec/rit/01/?room=2&rec=25
выступление Сергея Бережного (@veged) на РИТ 2011)).

## Необходимые инструменты
Для того, чтобы пройти по всем шагам этого мануала, вам нужно установить
((https://github.com/bem/bem-tools bem tools)). Это набор инструментов с
command line интерфейсом для оперирования БЭМ-сущностями и сборки проекта.
Инструкция по установке есть в описании репозитория.

Я буду использовать команду ##bem create## для создания файлов технологий. Кроме
того, вы увидите, как работает ##bem server## -- сборщик страниц на лету.

## Болванки для создания проекта
Создание БЭМ-проекта можно начинать с копирования специальных репозиториев, где
всё настроено для использования bem tools.

### Как устроен project-stub
Один из таких репозиториев -- ((https://github.com/bem/project-stub
project-stub))*1. Это минимальная конфигурация для использования БЭМ-сборки.

В проекте есть файл ##packadge.json##, подтягивающий необходимые для проекта
npm-пакеты. В нашем случае это пакет ##bem## для локального использования.

Директория ##.bem## используется для хранения конфигураций уровня
переопределения.\\
По БЭМ уровни переопределения -- это сам проект, директории с блоками и
дирректории с бандлами (страницами)).

#### Конфигурация проекта
Для уровня проекта необходим конфигурирующий файл
##((https://github.com/bem/project-stub/blob/master/.bem/make.js make.js))##.
Он сообщает командам ##bem make## и ##bem sever## информацию о том, как собирать
проект.
В этом примере задаются директории блоков и бандлов, при помощи RegExp-based
синтаксиса, устанавливаются необходимые библиотеки и перечисляются технологии,
которые необходимо собирать на уровнях бандлов.

#### Используемые библиотеки
На данный момент проект использует 2 библиотеки:
  * ((https://github.com/bem/bemhtml bemhtml))\\
    В библиотеке есть один блок, подключение которого позволяет любому проекту
    использовать шаблонизатор BEMHTML.
 * ((https://github.com/bem/bem-bl bem-bl))\\
   Библиотека простых блоков.

В проекте есть 3 уровня переопределения: 2 для блоков и один для бандлов
(страниц).

#### Уровни переопределения
Уровни для блоков называются
((https://github.com/bem/project-stub/tree/master/common.blocks common.blocks))
и ((https://github.com/bem/project-stub/tree/master/desktop.blocks
desktop.blocks)).\\
Настройки уроней находятся в файлах ##.bem/level.js##. Для этих уровней они
одинаковые, наследуются от одного и того же описания уровня
((https://github.com/bem/project-stub/blob/master/.bem/levels/blocks.js
/.bem/levels/blocks.js)) и ничего не переопределяют. Список технологий,
используемых блоками, в проекте ##project-stub## обнулён, на базе этого проекта может быть
построен любой с любыми технологиями.

На уровне ##common.blocks## находится лишь один блок, описывающий зависимости в
технологии
((https://github.com/bem/project-stub/blob/master/common.blocks/i-bem/__dom/i-bem__dom.deps.js
deps.js)):

%%hl js
({
  mustDeps: { block: 'bemhtml' },
  noDeps: { block: 'i-bem', elems: 'html' }
})
%%

Такая зависимость позволяет подключить ко всем страницам шаблонизатор
##BEMHTML##. Он нужен для любой версии сайта, поэтому находится на уровне
##common.blocks##.\\
Директива ##noDeps## исключает подключение шаблонизатора из библиотеки ##bem-bl##.
Это временная мера на период, пока шаблонизатор переезжает в отдельную библиотеку,
но сохраняется обратная совместимость.

На уровне ##desktop.blocks## определён блок
((https://github.com/bem/project-stub/tree/master/desktop.blocks/b-page
b-page)). Его зависимости обеспечивают подключение кода, который инициализирует
JavaScript всех блоков по domReady:

%%hl js
({
    mustDeps: [
        {
            block: 'i-bem',
            elem: 'dom',
            mods: { init: 'auto' }
        },
        { block: 'bemhtml' }
    ],
    noDeps: [
        {
            block: 'i-bem',
            elem: 'html'
        }
    ]
})
%%

Уровень переопределения ##desktop.bundles## содержит входные данные для страниц
и настройки сборки.\\
Как и все настройки уровня, конфигурация сборки содержится в ((https://github.com/bem/project-stub/blob/master/desktop.bundles/.bem/level.js
файле .bem/level.js)) уровня. Там прописано наследование от общего файла
для бандлов ((https://github.com/bem/project-stub/blob/master/.bem/levels/bundles.js /.bem/levels/bundles.js))
и собственные доопределения.\\
Там же вы можете видеть список уровней переопределения, блоки которых
будут использоваться для сборки страниц этого бандла.

#### Настройки сборки
В общем конфигурационном файле про бандлы ((https://github.com/bem/project-stub/blob/master/.bem/levels/bundles.js
/.bem/levels/bundles.js)) указано, по каким шаблонам собирать различные технологии.

### Как устроен full-stack-start
Репозиторий ((https://github.com/bem/full-stack-starter full-stack-starter))*2
имеет такую же архитектуру, но немного расширен для использования полного стека
БЭМ.

#### Настройки уровней с блоками
Для уровней с блоками здесь определено, по каким шаблонам должны создаваться
файлы технологий блоков.Это сделано в файле
((https://github.com/bem/full-stack-starter/blob/master/.bem/levels/blocks.js
./bem/levels/level.js)).\\
Шаблон определяет, с каким содержимым создастся файл блока, элемента или
модификатора при использовании команды ##bem create##.
Для большинства технологий используются дефолтные шаблоны из bem tools. Для
JavaScript файлов блоков -- шаблон из библиотеки bem-bl, а для файлов с BEMHTML
-- шаблон из библиотеки bemhtml.

Также определён дефолтный список технологий. Это те технологии, с которыми
по-умолчанию создаётся новый блок.

#### Настройки уровней с бандлами
Настройки уровней, хранящих собранные страницы изменены несильно. Изменения
внесены в файл
((https://github.com/bem/full-stack-starter/blob/master/.bem/levels/bundles.js
./bem/levels/bundles.js)) и заключаются в определении дефолтной технологии для
страниц.\\
Проект расчитан на описание всех страниц в ##bemjson##.

Шаблон технологии bemjson, использующийся при создании новых страниц, также
размещён в проекте в файле
((https://github.com/bem/full-stack-starter/blob/master/.bem/techs/bemjson.js.js
./bem/techs/bemjson.js.js)).

## Создание собственного репозитория проекта
Новый проект создаётся простым копированием репозитория:

%%hl xml
$ git clone git://github.com/bem/full-stack-starter.git my-pretty-project
$ cd my-pretty-project/
$ rm -rf .git
$ git init
%%

Затем проект нужно собрать. Для этого запускается команда

%%hl xml
make
%%

Это занимает некоторое время, потому что именно в этот момент в директорию
проекта устанавливаются все необходимые npm-пакеты.\\
В конце вы увидите следующее сообщение:

%%hl xml
info: Server is listening on port 8080. Point your browser to
http://localhost:8080/
%%

На вашем компьютере запустился ##bem server##*3 -- инструмент для разработки,
который будет автоматически пересобирать ваш проект, если вы внесете в него
изменения.

## Внесение изменения в страницы
Сейчас на вашем проекте есть одна страница
((http://localhost:8080/desktop.bundles/index/index.html index.html)), которую
вы можете открыть в браузере.\\
Первый запрос к странице будет обрабатываться заметное время, потому что в этот
момент bem server подгружает необходмые для её сборки библиотеки.

Вы можете отредактировать страницу, меняя файл
##desktop.bundles/index/index.bemjson.js##.

### Описание блока в bemjson
Сначала мы разместим на странице шапку. В терминах БЭМ это блок ##head##:

%%hl js
{
  block: 'head'
}
%%

((https://gist.github.com/4175550))

Перезагрузив страницу, вы увидите что в ней появился соответствующий ##<div>##.

Шапку мы наполним содержанием: форма поиска, логотип и блок ##layout##,
располагающий их как нужно.

Сначала в bemjson-описании страницы внутрь блока ##head## помещаем блок
##layout## с двумя элементами: ##left## и ##right##.
((https://gist.github.com/4175573)).

Это создаст необходимую разметку (вы можете увидеть её, обновив страницу), к
которой нужно написать стили. То есть реализовать блок ##layout## в технологии
##CSS##.

## Создание блока
Для создания файла технологии воспользуемся командой ##bem create##.

%%hl xml
$ bem create block -l desktop.blocks/ -T css layout
%%

Команда создаст файл ##desktop.blocks/layout/layout.css##, в котором уже есть
селектор, соответствующий файлу блока. Правило нужно дополнить соответственно
назначению блока. Сейчас можно просто скопировать:
((https://gist.github.com/4175598))

Подробно о возможностях команды ##bem create## можно узнать, набрав ##bem create
-~-help##.

## Использование блоков из библиотек
Вложенные в ##layout## блоки поисковой формы и логотипа реализовывать
самостоятельно не нужно. Они уже реализованы в
((http://bem.github.com/bem-bl/index.ru.html библиотеке bem-bl)), достаточно
просто задекларировать их на странице.

У каждого из блоков библиотеки есть своя страница. Например,
((http://bem.github.com/bem-bl/sets/common-desktop/b-search/b-search.ru.html
страница блока b-search)). Она описывает блок, а внизу можно найти несколько
iframe с примерами его использования. По ссылке ##исходный код## можно найти тот
BEMJSON, который нужно вставить на страницу для использования блока.

Для нашей страницы мы воспользуемся блоками
##((http://bem.github.com/bem-bl/sets/common-desktop/b-search/b-search.ru.html
b-search))## и
##((http://bem.github.com/bem-bl/sets/common-desktop/b-logo/b-logo.ru.html
b-logo))##.\\
((https://gist.github.com/4175640))

Картинку для логотипа можно взять
((http://toivonen.github.com/online-shop-dummy/desktop.blocks/b-logo/b-logo.png
отсюда)) или указать свою.

### Доопределение блоков библиотек
#### Доопределение в CSS
Любой блок библиотеки можно доопределить (дописать) на своём уровне в любой
технологии. Некоторые блоки специально написаны с учётом этой возможности.

Например, используемый нами блок ##b-logo## предоставляет только нужную
разметку. CSS для неё каждый разработчик может написать сам, потому что всем
нужна разная разметка.

Доопределение блока ничем не отличается от создания блока на своём уровне.
Единственное требование -- совпадение имён с библиотечным блоком.

%%hl xml
$ bem create block -l desktop.blocks/ -T css b-logo
%%

Разметку для блока можно взять отсюда: ((https://gist.github.com/4175675))

То же самое для блока ##b-search##:

%%hl xml
$ bem create block -l desktop.blocks/ -T css b-search
%%

#### Доопределение BEMHTML
При необходимости изменить разметку, мы должны переопределить технологию блока
BEMHTML (шаблоны, отвечающие за создание разметки).

Для данной страницы нужен дополнительный контейнер, чтобы сделать её
центрированной.

Создаём на своём уровне переопределения технологию ##BEMHTML## для блока
##b-page##:

%%hl xml
$ bem create block -l desktop.blocks/ -T bemhtml b-page
%%

В получившемся файле ##desktop.blocks/b-page/b-page.bemhtml## нужно написать
код, оборачивающий контент блока в дополнительный контейнер.
((https://gist.github.com/4175742)).*4

Для получившейся разметки создаются свои CSS-правила:

%%hl xml
$ bem create block -l desktop.blocks/ -T css b-page
%%

Контент для получившегося файла ##desktop.blocks/b-page/b-page.css## можно
скопировать отсюда: ((https://gist.github.com/4175763))

А для того, чтобы блок шапки был заметен на странице, я задам ему border:

%%hl xml
$ bem create block -l desktop.blocks/ -T css head
%%
Контент для файла ##desktop.blocks/head/head.css##:
((https://gist.github.com/4175776)).

## BEMHTML шаблоны
В странице не обязательно полностью описывать всю структуру блока, т.к. у
шаблонов есть возможность принять эту логику на себя.

Проектируя свой собственный блок, вы можете сделать так, что его декларация
очень короткая и нужна только для передачи данных, а всю разметку делает шаблон.

Например, давайте разместим на странице список товаров. Он представлен в
BEMJSON-декларации страницы блоком ##goods##, и декларация содержит необходимые
данные ((https://gist.github.com/4176078)).

Для того, чтобы эти данные превратились в нужную разметку, блок должен быть
реализован в технологии BEMHTML. Для внешнего вида -- технология CSS.\\
Если при создании блока не указывать флаг ##-T##, он создастся во всех
технологиях, определённых как дефолтные для этого уровня:

%%hl xml
$ bem create block -l desktop.blocks goods
%%

В BEMHTML шаблоне блока (##desktop.blocks/goods/goods.bemhtml##) нужно написать
код, который превратит JSON с данными в элементы блока. А также, пользуясь
модой ##tag## указать, какими DOM-элементами представить блок и его элементы.\\
((https://gist.github.com/4176118))

Шаблон может создавать не только элементы блока, но и другие блоки. Например,
цену товара можно завернуть в ссылку, используя для этого блок ##b-link## из
библиотеки ##bem-bl##.\\
Код шаблона при этом изменится вот так ((https://gist.github.com/4176996)).

Кроме того, для того, чтобы избежать каскада при оформлении этой ссылки стилями,
её можно пометить как элемент блока ##goods##
((https://gist.github.com/4177113)).

Кроме этого, нужно пометить элементы о новых товарах модификатором и добавить
выравнивающих элементов. ((https://gist.github.com/4177157))

CSS для блока можно скопировать отсюда ((https://gist.github.com/4177163)).

Также понадобится CSS для IE.

%%hl xml
$ bem create block -l desktop.blocks/ -T ie.css goods
%%
Содержание для получившегося файла ##desktop.blocks/goods/goods.ie.css## можно
взять здесь ((https://gist.github.com/4177174)).

## Зависимости блоков
Кроме декларации нужно гарантировать подключение к странице шаблонов, CSS и
JavaScript блока. Для этого у блока можно описать зависимости, это делается
представлением блока в технологии ##deps.js##.

%%hl xml
$ bem create block -l desktop.blocks/ -T deps.js goods
%%

Секция ##mustDeps## описывает зависимости, которые обязательно нужно подключить
до текущего блока. В данном случае она не нужна, можно воспользоваться менее
строгой зависимостью ##shouldDeps##, указав, что нужен блок ##b-link##.
((https://gist.github.com/4177031)).

## Подключение библиотек
Я хочу представить шапку и каждый товар модными прямоугольниками с тенью. Блок
для этого я позаимстую из ((https://github.com/john-johnson/j библотеки моего
друга)).\\
Там есть всего один блок, который называется ##box## и делает то, что мне нужно.

Чтобы получить код библиотеки, мне нужно указать её адрес в ##./bem/make.js##,
по аналогии с соседними библиотеками.\\
((https://gist.github.com/4177229))

А также указать в настройках бандлов (страниц), что этот уровень нужно
использовать при сборке. Это делается в файле
##desktop.bundles/.bem/level.js##.\\
((https://gist.github.com/4177250))

К сожалению, пока что при изменении конфигурации проекта приходится
перезапускать bem server. Текущий процесс придётся прервать и снова набрать
команду ##make##.\\
В будущих версиях необходимость перезапуска обещают убрать.

## Миксы блоков и элементов
Теперь можно использовать блок ##box##. Я могу просто обернуть им мои блоки. Но
чтобы сэкономить разметку, можно воспользоваться миксами (mix).

Миксы позволяют разместить на одной DOM-ноде несколько блоков, или блок и
элемент, или несколько элементов.

Миксы можно задавать во входных данных (BEMJSON). Например,  можно смешать блок
##head## с блоком ##box##, изменив код страницы.\\
((https://gist.github.com/4177292))

Также можно применять миксы в BEMHTML шаблонах. Смешивать можно не только блоки,
но и элементы с блоками.\\
В шаблоне блока ##goods## я смешаю каждый элемент ##item## с блоком ##box##.\\
((https://gist.github.com/4177350))

---------------------
*1. Репозиторий описан в ревизии
((https://github.com/bem/project-stub/commit/ebf605bc2ad031b73fef562df10d23a8b1edd63c
ebf605bc2a))
*2. Репозиторий описан в ревизии
((https://github.com/bem/full-stack-starter/commit/4e24d717e614aa3d7d3c060a6301b68ff6ec6424
4e24d717e6))
*3 TODO: Вставить материалы про bem server
*4 Информацию о синтаксисе шаблонизатора BEMHTML можно найти в референсе
((https://github.com/bem/bemhtml/blob/master/common.docs/reference/reference.ru.md))
